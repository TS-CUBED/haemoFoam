<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Torsten Schenkel" />
  <title>HaemoFOAM</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <script src="/usr/share/javascript/mathjax/tex-mml-chtml.js" type="text/javascript"></script>
</head>
<body>
<header id="title-block-header">
<h1 class="title">HaemoFOAM</h1>
<p class="author">Torsten Schenkel</p>
</header>
<p><code>haeomFoam</code> is a Finite Volume code for blood flow simulations. It is written in `C++` using the OpenFOAM framework and includes some additional features:</p>
<ul>
<li>non-Newtonian rheology models, in particular the Quemada model (<a href="#citeproc_bib_item_7">4</a>) and a modified Krieger-Dougherty model (<a href="#citeproc_bib_item_1">4</a>), as well as the original Krieger model (<a href="#citeproc_bib_item_2">4</a>).</li>
<li>haematocrit transport model based on (<a href="#citeproc_bib_item_3">4</a>)</li>
<li>Haematocrit Transport Model (<a href="#citeproc_bib_item_9">4</a>)</li>
<li>Windkessel BCs (<a href="#citeproc_bib_item_10">4</a>), adapted from code written by colleagues at Imperial College, London (<a href="#citeproc_bib_item_5">4</a>)</li>
</ul>
<h1 id="installation">Installation</h1>
<p><code>haemoFoam</code> is developed on <a href="https://www.openfoam.com">ESI OpenFOAM</a>. The current development version is v2106. It will not work on Foundation OpenFOAM, or of FOAM Extend. There are some conditional compiler statements in the code, which suggest that it does, but these versions are no longer maintained at the moment.</p>
<p>Installation of <code>haemoFoam</code> requires a full installation of OpenFOAM, including the development libraries, and C++ compiler. It has only been tested on <a href="https://www.ubuntu.com">Ubuntu Linux LTS</a> (or derivatives like <a href="https://www.linuxmint.com">LinuxMint</a>, or <a href="https://pop.system76.com/">Pop!-OS LTS</a> with OpenFOAM installed from the <a href="https://develop.openfoam.com/Development/openfoam/-/wikis/precompiled/debian">PPA</a>. It should work on any other Linux based OpenFOAM installation, though (self-compiled on CentOS7 HPC cluster is one of the test-systems, as well).</p>
<ul>
<li><p>Download the latest release of <code>haemoFoam</code> (if you want to contribute to development, you can also clone the github repository, but keep in mind that I will update the code regularly, so things may break!).</p></li>
<li><p>Unpack the archive into <code>~/OpenFOAM/yourUserName-vYYMM/applications/</code></p></li>
<li><p>Compile <code>haemoFoam</code> after initialising OpenFOAM:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="ex">openfoam2106</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="bu">cd</span> ~/OpenFOAM/<span class="va">$USER</span>-v2106/applications/haemoFoam</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a><span class="ex">./Allwmake</span></span></code></pre></div>
<p>This will install <code>haemoFoam</code> for the current user in <code>~/OpenFOAM/$USER-v2106/platforms/linux.../bin</code></p></li>
</ul>
<h2 id="binaries">Binaries</h2>
<p><code>haemoFoam</code> comes with three executables:</p>
<ol>
<li><code>haemoSimpleFoam</code> - steady state solver</li>
<li><code>haemoPimpleFoam</code> - transient solver, can be run in <code>PIMPLE</code> or <code>PISO</code> mode</li>
<li><code>haemoPostProcess</code> - post-processing utility, calculates wall-shear-stress derived metrics. Needs <code>wallShearStress</code> fields to be calculated either at run-time (see Function Objects) or using the <code>-postProces</code> option[fn::Note that the postProcessing routine does not work with the windkessel boundary condition at the moment, so using the function object to write the <code>wallShearStress</code> field at run-time is the recommended way.)</li>
</ol>
<h2 id="models">Models</h2>
<p><code>haemoFoam</code> includes the following models:</p>
<h3 id="viscosity-models">Viscosity models</h3>
<ul>
<li><strong>Carreau</strong> (<code>libCarreau.so</code>) - implementation of the Carreau model as implemented in Fluent (to allow for one-to-one comparisons with Fluent). This model does NOT use the haematocrit transport model!<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></li>
<li><strong>KriegerDougherty</strong> (<code>libKriegerDougherty.so</code>) - traditional Krieger-Dougherty model (<a href="#citeproc_bib_item_2">4</a>).</li>
<li><strong>Krieger5</strong> (<code>libKrieger5.so</code>) - a modified 5-parameter Krieger model after (<a href="#citeproc_bib_item_1">4</a>).</li>
<li><strong>Yeleswarapu</strong> (<code>libYeleswarapu.so</code>) - Carreau-type model after (<a href="#citeproc_bib_item_12">4</a>),(<a href="#citeproc_bib_item_11">4</a>).</li>
<li><strong>Quemada</strong> (<code>libQuemada.so</code>) - the main development model. Based on (<a href="#citeproc_bib_item_6">4</a>)(<a href="#citeproc_bib_item_8">4</a>)(<a href="#citeproc_bib_item_7">4</a>).</li>
</ul>
<p>All but the Carreau model use the local haemotocrit and shear rate to calculate the viscosity.</p>
<p>Refer to (<a href="#citeproc_bib_item_9">4</a>) for details on the implementation.</p>
<h3 id="boundary-conditions">Boundary conditions</h3>
<ul>
<li><strong>WKBC</strong> - 3-element windkessel boundary condition based on code written by Andris Piebalgs, Boram Gu, Emily Manchester, Imperial College London, who kindly let me have their <a href="https://github.com/KeepFloyding/OpenFOAM-phys-flow">original code</a>. Implemented as part of <code>haemoPimpleFoam</code><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</li>
<li><strong>splitFlowRateOutletVelocity</strong> (<code>libSplitFlowRateOutletVelocity.so</code>) - A split flow rate outlet condition. Not recommended<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>, but included since there are many models out there that use this kind of BC. Forces outlet flow rate at the outlet to match a chosen percentage of the inlet flow rate.</li>
</ul>
<h1 id="case-setup">Case setup</h1>
<p><code>haemoFoam</code> cases are set up in a similar fashion as a regular <code>pimpleFoam</code> case. I will assume here, that you know how to do that and will focus on the differences:</p>
<h2 id="loading-the-model-libraries">Loading the model libraries</h2>
<p>The new models need to be loaded in <code>system/controlDict</code> in the <code>libs</code> section. E.g., to load the Quemada model, the flow split, and the Groovy<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> BC, the <code>controlDict</code> file will start with:</p>
<pre class="example"><code>/*--------------------------------*- C++ -*----------------------------------*\
| =========                 |                                                 |
| \\      /  F ield         | OpenFOAM: The Open Source CFD Toolbox           |
|  \\    /   O peration     | Version:  v1812                                 |
|   \\  /    A nd           | Web:      www.OpenFOAM.com                      |
|    \\/     M anipulation  |                                                 |
\*---------------------------------------------------------------------------*/


FoamFile
{
    version     2.0;
    format      ascii;
    class       dictionary;
    location    &quot;system&quot;;
    object      controlDict;
}
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * //

libs
(
    &quot;libQuemada.so&quot;
    &quot;libgroovyBC.so&quot;
    &quot;libsplitFlowRateOutletVelocity.so&quot;
);


application     haemoPimpleFoam;
</code></pre>
<h2 id="haematocrit-field">Haematocrit field</h2>
<h3 id="bcs">BCs</h3>
<p>The H (haematocrit) field needs an initial and boundary condition file <code>0/H</code>. This contains the volume fraction of haematocrit (dimensionless).</p>
<ul>
<li><p>Inlet: <code>fixedValue</code> - give average H value. Alternatively you can give an H profile using something like <code>groovyBC</code>.</p></li>
<li><p>Outlets: <code>inletOutlet</code> - should there be backflow on the outlet, we need to provide the H value for the inflow (otherwise this will be zero, which will cause instability).</p></li>
<li><p>Walls: I use <code>slip</code> to allow arbitrary gradients, <code>fixedGradients</code> should work as well.</p></li>
</ul>
<pre class="example"><code>/*--------------------------------*- C++ -*----------------------------------*\
| =========                 |                                                 |
| \\      /  F ield         | OpenFOAM: The Open Source CFD Toolbox           |
|  \\    /   O peration     | Version:  v2106                                 |
|   \\  /    A nd           | Web:      www.OpenFOAM.com                      |
|    \\/     M anipulation  |                                                 |
\*---------------------------------------------------------------------------*/


FoamFile
{
    version     2.0;
    format      ascii;
    class       volScalarField;
    location    &quot;0&quot;;
    object      H;
}
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * //

dimensions      [0 0 0 0 0 0 0];

internalField   uniform 0.45;

boundaryField
{
    ICA
    {
        type            inletOutlet;
        inletValue      uniform 0.45;
        value           uniform 0.45;
    }
    ECA
    {
        type            inletOutlet;
        inletValue      uniform 0.45;
        value           uniform 0.45;
    }
    WALL
    {
        type            slip;
    }
    APEX
    {
        type            slip;
    }
    SINUS
    {
        type            slip;
    }
    CCA
    {
        type            fixedValue;
        value           uniform 0.45;
    }
}


// ************************************************************************* //
</code></pre>
<h3 id="solver-settings">Solver settings</h3>
<p>The haemotocrit field is simulated using a transport equation. This means it needs discretisation schemes for all terms set in <code>fvSchemes</code> and convergence criteria in <code>fvSolution</code>. Refer to the tutorial case for examples.</p>
<h2 id="boundary-conditions-1">Boundary conditions</h2>
<p>Most OpenFOAM boundary conditions are available in <code>haemoFoam</code> as well.</p>
<p>However, there is a limitation in the implementation of the windkessel boundary condition in <code>haemoFoam</code>. Even if this BC is not needed, the configuration file (<code>windkesselProperties</code>) needs to be present in the <code>constant</code> directory<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>.</p>
<p>Here I only describe the special boundary conditions in <code>haemoFoam</code>.</p>
<h3 id="windkessel-boundary-conditions">Windkessel Boundary Conditions</h3>
<p>Windkessel BCs were implemented using code developed by Andris Piebalgs at Imperial College (,Piebalgs <a href="#citeproc_bib_item_4">4</a>).</p>
<p>The BCs are set in the boundary/initial condition directory <code>0</code> and in the <code>constant</code> directory in two files:</p>
<ul>
<li><p>the <code>p</code> boundary condition file (in <code>0</code>), where each WK outlet gets an entry of the form</p>
<pre><code>outlet_name
  {
      type            WKBC;
      index           0;
      value           uniform 0;
  }
</code></pre>
<p>where the <code>index</code> is a number that has to match the entry in</p>
<ul>
<li>the <code>windkesselProperties</code> file (in <code>constant</code>), where the parameters are set:</li>
</ul></li>
</ul>
<pre><code>/*--------------------------------*- C++ -*----------------------------------*\
| =========                 |                                                 |
| \\      /  F ield         | OpenFOAM: The Open Source CFD Toolbox           |
|  \\    /   O peration     | Version:  4.0                                   |
|   \\  /    A nd           | Web:      www.OpenFOAM.org                      |
|    \\/     M anipulation  |                                                 |
\*---------------------------------------------------------------------------*/
FoamFile
{
    version     4.0;
    format      ascii;
    class       dictionary;
    object      windkesselProperties;
}
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * //

outlet_1
{
    C                   10.1e-10;
    R                   17.1e+08;        // commonly R_2 or R_distal
    Z                   6.3e+07;         // commonly R_1 or R_proximal
    outIndex            0;               // must equal &#39;index&#39; value in 0/p
    FDM_order           1;               // backward FD order: up to 3rd order

    // Initialise WK parameters
    // also useful to set initial condidions to speed up pressure development
    Flowrate_threeStepBefore        0;
    Flowrate_twoStepBefore          0;
    Flowrate_oneStepBefore          0;
    Pressure_twoStepBefore          0;
    Pressure_oneStepBefore          0;
    Pressure_start                  0;

}

outlet_2
{
    C                   4.1e-10;
    R                   41.7e+08;
    Z                   17.6e+07;
    outIndex            1;
    FDM_order           1;
    Flowrate_threeStepBefore        0;
    Flowrate_twoStepBefore          0;
    Flowrate_oneStepBefore          0;
    Pressure_twoStepBefore          0;
    Pressure_oneStepBefore          0;
    Pressure_start                  0;
}

// ************************************************************************* //
</code></pre>
<p><strong>Important Notes:</strong></p>
<ul>
<li>The order of the finite difference method to solve the windkessel equation can be set to up to third order. However for realistic cases, first order is sufficient, and higher orders can become unstable.</li>
<li>The parameters for the windkessel properties are given in SI-units. In most publications these will be given in physiological units, e.g., <span class="math inline">\(\left[ mm_{Hg}.ml^{-1}.s \right]\)</span>. These need to be converted to SI-units!</li>
<li>If the windkessel properties are not available, fixed relative pressures at the outlets are a reasonable alternative. A simple <code>fixedValue</code> BC with <code>value uniform 0</code> will give realistic flow distributions in most cases (based on diameter scaling).]</li>
</ul>
<h3 id="flow-split-boundary-conditions">Flow split boundary conditions</h3>
<p>These BCs are implemented to allow comparisons to some published cases that use Fluent split flow outlet condition. These BCs are typically unphysiological and can deliver unreliable results. They are typically employed where there are data available at the outlets, e.g., from echo or MRI flux measurements.</p>
<p>The flow split boundary condition works in cases where there is a single inlet<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> and multiple outlets. One outlet needs to be set as a free outlet (<code>zeroGradient</code>) and the others are set as <code>splitFlowRateOutletVelocity</code> in <code>0/U</code>:</p>
<pre class="example"><code>/*--------------------------------*- C++ -*----------------------------------*\
| =========                 |                                                 |
| \\      /  F ield         | OpenFOAM: The Open Source CFD Toolbox           |
|  \\    /   O peration     | Version:  v1812                                 |
|   \\  /    A nd           | Web:      www.OpenFOAM.com                      |
|    \\/     M anipulation  |                                                 |
\*---------------------------------------------------------------------------*/


FoamFile
{
    version     2.0;
    format      ascii;
    class       volVectorField;
    location    &quot;0&quot;;
    object      U;
}
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * //

dimensions      [0 1 -1 0 0 0 0];

internalField   uniform (0 0 0.1);

boundaryField
{
    ICA
    {
        type            splitFlowRateOutletVelocity;
        inletPatch      &quot;CCA&quot;;
        flowSplit       0.66;
        value           uniform ( 0 0 0.1 );
    }
    ECA
    {
        type            zeroGradient;
    }


....
</code></pre>
<p>The pressure BCs for this case are <code>zeroGradient</code> for the split flow outlets, and <code>fixedValue</code> for the free outlet (in <code>0/p</code>):</p>
<pre class="example"><code>/*--------------------------------*- C++ -*----------------------------------*\
| =========                 |                                                 |
| \\      /  F ield         | OpenFOAM: The Open Source CFD Toolbox           |
|  \\    /   O peration     | Version:  v1812                                 |
|   \\  /    A nd           | Web:      www.OpenFOAM.com                      |
|    \\/     M anipulation  |                                                 |
\*---------------------------------------------------------------------------*/


FoamFile
{
    version     2.0;
    format      ascii;
    class       volScalarField;
    location    &quot;0&quot;;
    object      p;
}
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * //

dimensions      [0 2 -2 0 0 0 0];

internalField   uniform 8.5;

boundaryField
{
    ICA
    {
        type            zeroGradient;
    }
    ECA
    {
        type            fixedValue;
        value           uniform 0;
    }

....
</code></pre>
<h2 id="function-objects">Function Objects</h2>
<p>There are a few things that we routinely look at when simulating blood flows. To save postprocessing time and file space, many of these can be written to text files at runtime. These can then be analysed and plotted without the need to load the field data.</p>
<p>The Wall Shear stress is a required one, the others are optional and are just the ones that I routinely use:</p>
<h3 id="wall-shear-stress-required-for-haemopostprocess">Wall Shear Stress (required for <code>haemoPostProcess</code>):</h3>
<p>Wall shear stress is an important metric for haemodynamic simulation. OpenFOAM does not calculate WSS, but has a function object that will do that. This will take turbulence and non-Newtonian models into account and calculate WSS as <span class="math inline">\(\nu_{eff} \frac{\partial\vec{u}}{\partial\vec{n}}\)</span>.</p>
<pre class="example"><code>wallShearStress
{
    // Mandatory entries (unmodifiable)
    type            wallShearStress;
    libs            (fieldFunctionObjects);

    // Optional entries (runtime modifiable)
    // patches         (WALL APEX SINUS); // (wall1 &quot;(wall2|wall3)&quot;);

    // Optional (inherited) entries
    // writePrecision  8;
    // writeToFile     true;
    // useUserTime     true;
    // region          region0;
    // enabled         true;
    // log             true;
    // timeStart       0;
    // timeEnd         1000;
    // executeControl  timeStep;
    // executeInterval 1;
    writeControl    outputTime;

}
</code></pre>
<p><em>Note: <code>writeControl outputTime;</code> synchronises the output of the field data with the output times of the rest of the data. Without this the wall shear stress data will be written every time step!</em></p>
<p><code>./postProcessing/wallShearStress/0/wallShearStress.dat</code> will contain min and max values for all patches - in this case also for the inlet/outlet patches, which can be ignored when plotting WSS in Paraview. In some cases these help avoid division by zero problems at the edges of the walls when calculating the WSS metrics.</p>
<pre class="example"><code># Wall shear stress
# Time          patch           min             max
0.01            CCA     (-2.285838e-03 -2.083722e-03 -1.215122e-03)     (1.951771e-03 1.997152e-03 1.098803e-03)
0.01            ICA     (-4.724931e-03 -5.578844e-03 -2.057902e-03)     (5.158803e-03 5.917156e-03 1.551159e-03)
0.01            ECA     (-7.802540e-03 -5.654608e-03 -1.776018e-03)     (5.327658e-03 8.974748e-03 3.580220e-04)
0.01            APEX    (-7.673434e-03 -2.424255e-03 -5.991218e-03)     (2.045973e-03 1.787954e-03 -4.718725e-04)
0.01            SINUS   (-1.249938e-03 -1.057508e-03 -7.173346e-03)     (2.467540e-03 1.757495e-03 1.624837e-03)
0.01            WALL    (-4.859152e-03 -2.770018e-03 -1.472179e-02)     (3.020219e-03 1.545451e-03 1.980882e-03)
</code></pre>
<h3 id="average-values-on-patches-e.g.-inlet-and-outlet-pressures">Average values on patches (e.g. inlet and outlet pressures)</h3>
<p>Create a section in the <code>functions</code> block of <code>controlDict</code> for all patches of interest; all fields can be averaged.</p>
<p>E.g. averaging over the common carotid arterie outflow (patch name <code>CCA</code>):</p>
<pre class="example"><code>averagesCCA
{
    type            surfaceFieldValue;
    libs            (&quot;libfieldFunctionObjects.so&quot;);
    enabled         yes;
    writeControl    timeStep;
    log             yes;
    writeFields     no;
    regionType      patch;
    name            CCA;
    operation       areaAverage;

    fields
    (
        p
        U
        H
    );
}
</code></pre>
<p>This file will be written to <code>./postProcessing/averagesCCA/&lt;startTime&gt;/0/surfaceFieldValue.dat</code> and look like this:</p>
<pre class="example"><code># Region type : patch CCA
# Faces       : 731
# Area        : 3.089305e-05
# Scale factor: 1.000000e+00
# Time          areaAverage(p)  areaAverage(U)  areaAverage(H)
0.001           2.747977e+01    (-2.650558e-09 -3.238202e-09 2.523065e-01)      4.500000e-01
0.002           2.370257e+00    (-2.673728e-09 -3.266508e-09 2.545120e-01)      4.500000e-01
0.003           9.029901e+00    (-2.697549e-09 -3.295612e-09 2.567795e-01)      4.500000e-01
0.004           9.070692e+00    (-2.722026e-09 -3.325515e-09 2.591095e-01)      4.500000e-01
0.005           9.100255e+00    (-2.747160e-09 -3.356221e-09 2.615020e-01)      4.500000e-01
</code></pre>
<p>Note that the velocity is a vector in parenthesis. These can cause problems with some import filters. A helpful command for removing these parenthesis is <code>sed -e "s/[()]//g" surfaceFieldValue.dat &gt; surfaceFieldValue_cleaned.dat</code>, or similar.</p>
<h3 id="flow-rates-volume-flow">Flow Rates (volume flow)</h3>
<p>These are similar to the averages. The flow rate can be calculated as the <code>sum</code> over the scalar flow <code>phi</code>. Calculating the outflow from the external carotid artery (ECA):</p>
<pre class="example"><code>flowRateECA
   {
        type            surfaceFieldValue;
        libs (&quot;libfieldFunctionObjects.so&quot;);
        enabled         yes;
        writeControl    timeStep;
        writeInterval   1;
        log             yes;
        writeFields     no;
        regionType      patch;
        name            ECA;
        operation       sum;

        fields
        (
            phi
        );
   }
</code></pre>
<p><em>Note: due to the orientation of the normal vector and since the volume flow is <span class="math inline">\((\vec{u} \cdot \vec{n})A\)</span> flow into the volume is negative and flow out of the volume is positive!</em></p>
<p>This file will be written to <code>./postProcessing/flowRateCCA/&lt;startTime&gt;/0/surfaceFieldValue.dat</code> and look like this:</p>
<pre class="example"><code># Region type : patch CCA
# Faces       : 731
# Area        : 3.089305e-05
# Scale factor: 1.000000e+00
# Time          sumphi
0.001           -7.794516e-06
0.002           -7.862651e-06
0.003           -7.932703e-06
0.004           -8.004682e-06
0.005           -8.078593e-06
</code></pre>
<h3 id="solver-info">Solver info</h3>
<p>Some additional information, like residuals, can be written to a text file for each time step. Note that this is only of limited use for the PIMPLE solver, since it will use the residual information in the first PIMPLE loop, not the last.</p>
<pre class="example"><code>solverInfo
{
    type            solverInfo;
    libs            (&quot;libutilityFunctionObjects.so&quot;);
    fields          (U H p);
    timeStart       3.01;
    writeResidualFields no;
}
</code></pre>
<p><em>Note: Adjust the <code>timeStart</code> to be greater than the <code>haemoSwitch</code> value in <code>haemoTransportProperties</code>, so the <code>H</code> solver will run. Otherwise the <code>H</code> residual will not be recorded!</em></p>
<h1 id="post-processing">Post-Processing</h1>
<h2 id="calculation-of-wss-metrics">Calculation of WSS metrics</h2>
<p><code>haemoFOAM</code> has postprocessing routines for the most important wall-shear-stress (WSS) derived metrics that are used in atherosclerosis risk prediction.</p>
<p>These require data over the last cycle of the simulation. In the examples the cycle length is 1s and data was written every 0.01s, data for the 6th cycle (5.01s to 6s) is evaluated.</p>
<p>The postprocessing is done in two steps (only one for serial runs):</p>
<ol>
<li><p><code>reconstructPar</code> to reconstruct the data from the distributed run (only reconstructing last cycle, <code>processor</code> directories can be removed after this step to save hard drive space):</p>
<p>#+begin<sub>example</sub> sh reconstructPar -time 5.01:6</p>
<p>#+end<sub>example</sub></p></li>
<li><p><code>haemoPostProcess</code> calculates the other shear stress metrics:</p>
<pre class="example"><code>haemoPostProcess -time 5.01:6
</code></pre></li>
</ol>
<h1 id="bibliography">Bibliography</h1>
<p><span id="citeproc_bib_item_1"></span>Hund, Samuel, Marina Kameneva, and James Antaki. 2017. “A Quasi-Mechanistic Mathematical Representation for Blood Viscosity.” <em>Fluids</em> 2 (1): 10. <a href="https://doi.org/10.3390/fluids2010010">https://doi.org/10.3390/fluids2010010</a>.</p>
<p><span id="citeproc_bib_item_2"></span>Krieger, Irvin M., and Thomas J. Dougherty. 1959. “A Mechanism for Non-Newtonian Flow in Suspensions of Rigid Spheres.” <em>Transactions of the Society of Rheology</em> 3 (1): 137–52. <a href="https://doi.org/10.1122/1.548848">https://doi.org/10.1122/1.548848</a>.</p>
<p><span id="citeproc_bib_item_3"></span>Phillips, Ronald J., Robert C. Armstrong, Robert A. Brown, Alan L. Graham, and James R. Abbott. 1992. “A Constitutive Equation for Concentrated Suspensions That Accounts for Shear-Induced Particle Migration.” <em>Physics of Fluids a: Fluid Dynamics</em> 4 (1): 30–40. <a href="https://doi.org/10.1063/1.858498">https://doi.org/10.1063/1.858498</a>.</p>
<p><span id="citeproc_bib_item_4"></span>Piebalgs, Andris. 2017. “Development of a Multi-Physics and Multi-Scale Model of Thrombolysis for Patient-Specific Appplications,” May. <a href="https://doi.org/10.25560/67674">https://doi.org/10.25560/67674</a>.</p>
<p><span id="citeproc_bib_item_5"></span>Pirola, S., Z. Cheng, O. A. Jarral, D. P. O’Regan, J. R. Pepper, T. Athanasiou, and X. Y. Xu. 2017. “On the Choice of Outlet Boundary Conditions for Patient-Specific Analysis of Aortic Flow Using Computational Fluid Dynamics.” <em>Journal of Biomechanics</em> 60 (July): 15–21. <a href="https://doi.org/10.1016/j.jbiomech.2017.06.005">https://doi.org/10.1016/j.jbiomech.2017.06.005</a>.</p>
<p><span id="citeproc_bib_item_6"></span>Quemada, D. 1977. “Rheology of Concentrated Disperse Systems and Minimum Energy Dissipation Principle - I. Viscosity-Concentration Relationship.” <em>Rheologica Acta</em> 16: 82–94. <a href="https://doi.org/10.1007/BF01516932">https://doi.org/10.1007/BF01516932</a>.</p>
<p><span id="citeproc_bib_item_7"></span>———. 1978a. “Rheology of Concentrated Disperse Systems III. General Features of the Proposed Non-Newtonian Model. Comparison with Experimental Data.” <em>Rheologica Acta</em> 17 (6): 643–53. <a href="https://doi.org/10.1007/BF01522037">https://doi.org/10.1007/BF01522037</a>.</p>
<p><span id="citeproc_bib_item_8"></span>———. 1978b. “Rheology of Concentrated Disperse Systems II. A Model for Non-Newtonian Shear Viscosity in Steady Flows.” <em>Rheologica Acta</em> 17 (6): 632–42. <a href="https://doi.org/10.1007/BF01522036">https://doi.org/10.1007/BF01522036</a>.</p>
<p><span id="citeproc_bib_item_9"></span>Schenkel, Torsten, and Ian Halliday. 2021. “Continuum Scale Non Newtonian Particle Transport Model for Hæ morheology.” <em>Mathematics</em> 9 (17): 2100. <a href="https://doi.org/10.3390/math9172100">https://doi.org/10.3390/math9172100</a>.</p>
<p><span id="citeproc_bib_item_10"></span>Westerhof, Nico, Jan-Willem Lankhaar, and Berend E. Westerhof. 2009. “The Arterial Windkessel.” <em>Medical &amp; Biological Engineering &amp; Computing</em> 47 (2): 131–41. <a href="https://doi.org/10.1007/s11517-008-0359-2">https://doi.org/10.1007/s11517-008-0359-2</a>.</p>
<p><span id="citeproc_bib_item_11"></span>Wu, Wei-Tao, Fang Yang, James F. Antaki, Nadine Aubry, and Mehrdad Massoudi. 2015. “Study of Blood Flow in Several Benchmark Micro-Channels Using a Two-Fluid Approach.” <em>International Journal of Engineering Science</em> 95 (Journal Article): 49–59. <a href="https://doi.org/10.1016/j.ijengsci.2015.06.004">https://doi.org/10.1016/j.ijengsci.2015.06.004</a>.</p>
<p><span id="citeproc_bib_item_12"></span>Yeleswarapu, K. K., M. V. Kameneva, K. R. Rajagopal, and J. F. Antaki. 1998. “The Flow of Blood in Tubes: Theory and Experiment.” <em>Mechanics Research Communications</em> 25 (3): 257–62. <a href="https://doi.org/10.1016/S0093-6413(98)00036-6">https://doi.org/10.1016/S0093-6413(98)00036-6</a>.</p>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>*Bird-Carreau* is available as an OpenFOAM model. All other OF viscosity models can be used as well. They will, however not link to the haematocrit model.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>This means that the <code>windkesselProperties</code> file must exist, even if these BC is not used. Will need to reimplement this in a cleaner way.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p>This BC is unphysiological. I would discourage it's use. It seems to have fallen out of favour recently, but there are many simulations - including some of mine - that use this BC if there is data from, e.g., echo doppler or similar. It can work in these cases, but I would recommend fixed pressure BCs if no windkessel data is available.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4" role="doc-endnote"><p>groovyBC is part of the "Swiss Army Knife for Foam" (swak4Foam) toolkit, which I recommend.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5" role="doc-endnote"><p>I will need to address this in an upcoming refactoring, but at the moment, I have decided to just leave it as is.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6" role="doc-endnote"><p>could be extended to multiple inlets<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
</body>
</html>
